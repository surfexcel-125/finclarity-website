<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal | Finclarity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        html { scrollbar-width: none; -ms-overflow-style: none; }
        html::-webkit-scrollbar { display: none; }
        body { background-color: #0c111e; color: #f4f6f9; font-family: 'Source Sans Pro', sans-serif; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Montserrat', sans-serif; }
        .sidebar-link { transition: all 0.2s ease; color: #a9a9b3; }
        .sidebar-link:hover, .sidebar-link.active { color: #ffffff; background-color: rgba(255, 255, 255, 0.08); }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }
        .glass-card { background: rgba(17, 24, 39, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .form-input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .main-button { background-color: #0052cc; color: white; transition: background-color 0.3s ease; }
        .main-button:hover { background-color: #0065ff; }
        .main-button:disabled { background-color: #003d99; cursor: not-allowed; }
        .delete-modal { transition: opacity 0.3s ease; }
        .delete-modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="antialiased">
    <div id="app-wrapper" style="display: none;">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 opacity-0 hidden"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-[#111827]/80 backdrop-blur-lg shadow-2xl z-50 transform -translate-x-full">
            <div class="p-6 flex flex-col h-full">
                <div class="flex justify-between items-center mb-8">
                    <div class="text-xl font-bold tracking-wider text-white"><a href="index.html">FINCLARITY</a></div>
                    <button id="close-sidebar-btn" class="text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <nav id="sidebar-nav" class="flex flex-col space-y-2 text-lg">
                    <a href="member_dashboard.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-tachometer-alt fa-fw w-6"></i><span>Dashboard</span></a>
                    <a href="portfolio.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-wallet fa-fw w-6"></i><span>Portfolio</span></a>
                    <a href="market_screener.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-search-dollar fa-fw w-6"></i><span>Market Screener</span></a>
                    <a href="articles.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-book-reader fa-fw w-6"></i><span>Our Articles</span></a>
                    <a href="news.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-newspaper fa-fw w-6"></i><span>Live News Feed</span></a>
                    <a href="economic_calendar.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-calendar-alt fa-fw w-6"></i><span>Economic Calendar</span></a>
                    <a href="trading_journal.html" class="sidebar-link active flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-book fa-fw w-6"></i><span>Trading Journal</span></a>
                    <a href="tools_calculators.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-tools fa-fw w-6"></i><span>Tools</span></a>
                    <a href="settings.html" class="sidebar-link flex items-center gap-4 p-3 rounded-lg"><i class="fas fa-user-cog fa-fw w-6"></i><span>Settings</span></a>
                </nav>
                <div class="mt-auto">
                    <a href="#" id="logout-btn" class="flex items-center gap-4 text-red-400 hover:text-red-300 hover:bg-red-500/10 p-3 rounded-lg transition-colors"><i class="fas fa-sign-out-alt fa-fw w-6"></i><span>Log Out</span></a>
                </div>
            </div>
        </aside>

        <div class="min-h-screen flex flex-col">
             <header id="header" class="bg-transparent backdrop-blur-md sticky top-0 z-30">
                <div class="container mx-auto flex justify-between items-center p-4">
                     <div class="flex items-center gap-4">
                        <button id="open-sidebar-btn" class="text-white hover:text-blue-400 p-2 rounded-full hover:bg-white/10"><i class="fas fa-bars fa-lg"></i></button>
                        <div class="text-2xl font-bold tracking-wider text-white">Trading Journal</div>
                    </div>
                    <nav class="flex items-center gap-4">
                         <span id="user-email" class="hidden sm:inline text-gray-300"></span>
                         <a href="settings.html" class="text-white p-2 rounded-full hover:bg-white/10"><i class="fas fa-user-circle fa-lg"></i></a>
                    </nav>
                </div>
            </header>

            <main class="container mx-auto p-4 md:p-8 flex-grow">
                <section id="analytics-dashboard" class="mb-10">
                    <h2 class="text-2xl font-bold text-center mb-4">Performance Analytics</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                        <div class="glass-card p-4"><span class="text-sm text-gray-400 block">Total P/L</span><span id="total-pl" class="text-2xl font-bold">-$--.--</span></div>
                        <div class="glass-card p-4"><span class="text-sm text-gray-400 block">Total Trades</span><span id="total-trades" class="text-2xl font-bold">0</span></div>
                        <div class="glass-card p-4"><span class="text-sm text-gray-400 block">Win Rate</span><span id="win-rate" class="text-2xl font-bold">--%</span></div>
                        <div class="glass-card p-4"><span class="text-sm text-gray-400 block">Profit Factor</span><span id="profit-factor" class="text-2xl font-bold">--</span></div>
                        <div class="glass-card p-4 col-span-2 md:col-span-1 lg:col-span-1"><span class="text-sm text-gray-400 block">Avg Win / Loss</span><span id="avg-win-loss" class="text-xl font-bold">-$-- / -$--</span></div>
                    </div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Log a New Trade</h2>
                            <form id="trade-form" class="space-y-4">
                                <div>
                                    <label class="text-sm text-gray-400">Symbol</label>
                                    <input type="text" id="trade-symbol" required class="form-input w-full mt-1 p-2 rounded-lg" placeholder="e.g., AAPL, BTCUSD">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Direction</label>
                                    <select id="trade-direction" class="form-input w-full mt-1 p-2 rounded-lg bg-[#0c111e]">
                                        <option value="long">Long</option>
                                        <option value="short">Short</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-sm text-gray-400">Entry Price</label>
                                        <input type="number" step="any" id="trade-entry" required class="form-input w-full mt-1 p-2 rounded-lg">
                                    </div>
                                    <div>
                                        <label class="text-sm text-gray-400">Exit Price</label>
                                        <input type="number" step="any" id="trade-exit" required class="form-input w-full mt-1 p-2 rounded-lg">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Position Size</label>
                                    <input type="number" step="any" id="trade-size" required class="form-input w-full mt-1 p-2 rounded-lg" placeholder="e.g., 100 shares, 1 lot">
                                </div>
                                <div>
                                    <label class="text-sm text-gray-400">Notes / Setup</label>
                                    <textarea id="trade-notes" rows="3" class="form-input w-full mt-1 p-2 rounded-lg" placeholder="Why did you take this trade?"></textarea>
                                </div>
                                <button type="submit" id="save-trade-btn" class="main-button w-full font-bold py-3 rounded-lg">Save Trade</button>
                                <p id="form-message" class="text-center text-sm mt-3 h-4"></p>
                            </form>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="glass-card p-6">
                            <h2 class="text-2xl font-bold mb-4">Trade History</h2>
                            <div id="trade-history" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
                                <p class="text-center text-gray-400">No trades logged yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none delete-modal">
        <div class="delete-modal-content glass-card p-8 rounded-2xl w-full max-w-sm text-center transform scale-95">
            <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p class="text-gray-300 mb-6">Are you sure you want to permanently delete this trade?</p>
            <div class="flex gap-4">
                <button id="cancel-delete-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";
        import { db, auth } from './js/main.js';

        let trades = [];
        let tradeToDeleteId = null;

        const totalPlEl = document.getElementById('total-pl');
        const totalTradesEl = document.getElementById('total-trades');
        const winRateEl = document.getElementById('win-rate');
        const profitFactorEl = document.getElementById('profit-factor');
        const avgWinLossEl = document.getElementById('avg-win-loss');
        const tradeHistoryContainer = document.getElementById('trade-history');
        const tradeForm = document.getElementById('trade-form');
        const saveTradeBtn = document.getElementById('save-trade-btn');
        const formMessage = document.getElementById('form-message');
        
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        function calculateAnalytics() {
            const totalTrades = trades.length;
            const totalPL = trades.reduce((acc, trade) => acc + trade.pl, 0);
            const winningTrades = trades.filter(t => t.pl > 0);
            const losingTrades = trades.filter(t => t.pl < 0);
            
            const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades) * 100 : 0;
            
            const grossProfit = winningTrades.reduce((acc, t) => acc + t.pl, 0);
            const grossLoss = Math.abs(losingTrades.reduce((acc, t) => acc + t.pl, 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : Infinity;

            const avgWin = winningTrades.length > 0 ? grossProfit / winningTrades.length : 0;
            const avgLoss = losingTrades.length > 0 ? grossLoss / losingTrades.length : 0;

            totalPlEl.textContent = `${totalPL.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}`;
            totalPlEl.className = `text-2xl font-bold ${totalPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            totalTradesEl.textContent = totalTrades;
            winRateEl.textContent = `${winRate.toFixed(1)}%`;
            profitFactorEl.textContent = isFinite(profitFactor) ? profitFactor.toFixed(2) : '∞';
            avgWinLossEl.innerHTML = `<span class="text-green-400">${avgWin.toLocaleString('en-US', {style:'currency', currency:'USD'})}</span> / <span class="text-red-400">${avgLoss.toLocaleString('en-US', {style:'currency', currency:'USD'})}</span>`;
        }
        
        function renderTrades() {
            if (trades.length === 0) {
                tradeHistoryContainer.innerHTML = '<p class="text-center text-gray-400">No trades logged yet.</p>';
                return;
            }
            
            tradeHistoryContainer.innerHTML = '';
            trades.forEach(trade => {
                const plColor = trade.pl >= 0 ? 'text-green-400' : 'text-red-400';
                const directionColor = trade.direction === 'long' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300';

                const tradeEl = document.createElement('div');
                tradeEl.className = 'bg-white/5 p-4 rounded-lg';
                tradeEl.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg text-white">${trade.symbol.toUpperCase()}</span>
                                <span class="text-xs font-semibold px-2 py-1 rounded-md ${directionColor}">${trade.direction.toUpperCase()}</span>
                            </div>
                            <p class="text-sm text-gray-400">${trade.createdAt.toDate().toLocaleString()}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg ${plColor}">${trade.pl.toLocaleString('en-US', {style: 'currency', currency: 'USD'})}</p>
                            <p class="text-xs text-gray-500">Entry: ${trade.entryPrice} &rarr; Exit: ${trade.exitPrice} (Size: ${trade.positionSize})</p>
                        </div>
                    </div>
                    ${trade.notes ? `<p class="text-sm text-gray-300 mt-2 pt-2 border-t border-white/10">${trade.notes}</p>` : ''}
                    <button data-id="${trade.id}" class="delete-trade-btn text-xs text-red-500 hover:text-red-400 mt-2">Delete</button>
                `;
                tradeHistoryContainer.appendChild(tradeEl);
            });
        }

        function showFormMessage(message, isError = false) {
            formMessage.textContent = message;
            formMessage.className = `text-center text-sm mt-3 h-4 ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => formMessage.textContent = '', 3000);
        }

        window.setupPage = () => {
             if (!auth.currentUser) return;
             const userId = auth.currentUser.uid;
             const tradesCollection = collection(db, `users/${userId}/trades`); // CORRECTED PATH
             const q = query(tradesCollection, orderBy("createdAt", "desc"));

             onSnapshot(q, (snapshot) => {
                trades = snapshot.docs.map(doc => {
                    const data = doc.data();
                    let pl = 0;
                    const positionSize = data.positionSize || 1;
                    if(data.direction === 'long') {
                        pl = (data.exitPrice - data.entryPrice) * positionSize;
                    } else {
                        pl = (data.entryPrice - data.exitPrice) * positionSize;
                    }
                    return { id: doc.id, ...data, pl };
                });
                renderTrades();
                calculateAnalytics();
             });

            tradeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                saveTradeBtn.disabled = true;
                saveTradeBtn.textContent = 'Saving...';

                const entryPrice = parseFloat(document.getElementById('trade-entry').value);
                const exitPrice = parseFloat(document.getElementById('trade-exit').value);
                const positionSize = parseFloat(document.getElementById('trade-size').value);

                if (isNaN(entryPrice) || isNaN(exitPrice) || isNaN(positionSize)) {
                    showFormMessage('Please enter valid numbers for prices and size.', true);
                    saveTradeBtn.disabled = false;
                    saveTradeBtn.textContent = 'Save Trade';
                    return;
                }

                const tradeData = {
                    symbol: document.getElementById('trade-symbol').value,
                    direction: document.getElementById('trade-direction').value,
                    entryPrice,
                    exitPrice,
                    positionSize,
                    notes: document.getElementById('trade-notes').value,
                    createdAt: serverTimestamp()
                };
                
                try {
                    await addDoc(tradesCollection, tradeData);
                    tradeForm.reset();
                    showFormMessage('Trade Saved!');
                } catch (error) {
                    console.error("Error adding trade: ", error);
                    showFormMessage('Error: Could not save trade.', true);
                } finally {
                    saveTradeBtn.disabled = false;
                    saveTradeBtn.textContent = 'Save Trade';
                }
            });
            
            tradeHistoryContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-trade-btn')) {
                    tradeToDeleteId = e.target.dataset.id;
                    deleteModal.classList.remove('opacity-0', 'pointer-events-none');
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                deleteModal.classList.add('opacity-0', 'pointer-events-none');
                tradeToDeleteId = null;
            });

            confirmDeleteBtn.addEventListener('click', async () => {
                if (tradeToDeleteId) {
                    try {
                        await deleteDoc(doc(db, `users/${userId}/trades/${tradeToDeleteId}`));
                    } catch (error) {
                        console.error("Error deleting trade: ", error);
                    } finally {
                        cancelDeleteBtn.click();
                    }
                }
            });
        };
    </script>
    <script type="module" src="js/main.js"></script>
</body>
</html>

